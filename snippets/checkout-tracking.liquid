<script>
const items =   [
  {% for item in cart.items %}
    {% if item.properties._promotionId and item.properties._promotionId != null %} 
       {{ item | json }} {% unless forloop.last%} , {% endunless %}
    {% endif %}
  {% endfor %}
  ]
  const currency = "{{cart.currency.iso_code}}" 
    const bindCheckoutButton = () => {
     document.querySelector('.rebuy-cart__checkout-button').addEventListener('click', (ev) => {
     items.forEach ( item => {
         const promotionId = item.properties._promotionId
          window.dataLayer.push({
            event: 'custom_begin_checkout',
            currency: currency,
            promotion_id: promotionId,
            value: item.final_price * 0.01,
            items: [
              {
                 item_id: `${item.product_id}`,
                 item_name: `${item.title}`,
                 price: item.final_price * 0.01,
                 quantity: `${item.quantity}`
               }]
        });
    });
  })}

  document.addEventListener('DOMContentLoaded' , () => {
    let checkRebuy = setInterval (() => {
     if(window.Rebuy?.SmartCart?.cart) {
      clearInterval(checkRebuy);
      checkRebuy = false;
      bindCheckoutButton();
    }
    },500);
    setTimeout(() => {
      if(checkRebuy) {
      clearInterval(checkRebuy)}
    },8000)
  });
</script>

