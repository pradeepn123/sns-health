{%- assign selected_variant = product.selected_or_first_available_variant -%}

{% if selected_variant.available == false %}
  {% style %}
    .quantity-selector {
      pointer-events: none;
      opacity: 0.5;
    }
  {% endstyle %}
{% endif %}

<div class="card {% if product.media.size > 0 %}card--collapsed{% endif %} {% if template.name == 'product' %}card--sticky{% endif %} no-border">
  {%- if section.settings.enable_image_zoom -%}
    <div id="product-zoom-{{ section.id }}" class="product__zoom-wrapper"></div>
  {%- endif -%}

  <div class="card__section">
    {% comment %}
      ------------------------------------------------------------------------------
      PRODUCT META
      ------------------------------------------------------------------------------
    {% endcomment %}

    {%- if section.settings.show_share_buttons -%}
      {%- capture share_buttons -%}
        {%- assign share_url = shop.url | append: product.url -%}
        {%- assign twitter_text = product.title | url_param_escape -%}
        {%- assign pinterest_description = product.description | strip_html | truncatewords: 15 | url_param_escape -%}
        {%- assign pinterest_image = product.featured_media | img_url: '1024x' | prepend: 'https:' -%}

        <ul class="social-media__item-list list--unstyled" role="list">
          <li class="social-media__item social-media__item--facebook">
            <a href="https://www.facebook.com/sharer.php?u={{ share_url }}" target="_blank" rel="noopener" aria-label="{{ 'general.social.facebook_share' | t }}">{%- render 'icon', icon: 'facebook' -%}</a>
          </li>

          <li class="social-media__item social-media__item--pinterest">
            <a href="https://pinterest.com/pin/create/button/?url={{ share_url }}{% if pinterest_image != blank %}&media={{ pinterest_image }}{% endif %}&description={{ pinterest_description }}" target="_blank" rel="noopener" aria-label="{{ 'general.social.pinterest_pin' | t }}">{%- render 'icon', icon: 'pinterest' -%}</a>
          </li>

          <li class="social-media__item social-media__item--twitter">
            <a href="https://twitter.com/share?{% if twitter_text != blank %}text={{twitter_text}}&{% endif %}url={{ share_url }}" target="_blank" rel="noopener" aria-label="{{ 'general.social.twitter_tweet' | t }}">{%- render 'icon', icon: 'twitter' -%}</a>
          </li>

          <li class="social-media__item">
            <a href="mailto:?&subject={{ product.title | escape }}&body={{ share_url }}" aria-label="{{ 'general.social.email_share' | t }}">{% render 'icon', icon: 'email' %}</a>
          </li>
        </ul>
      {%- endcapture -%}
    {%- endif -%}

    <div class="product-meta">
      {%- if template.name == 'product' and template != 'product.quick-view' -%}
        <div class="product-meta__reference">
          {%- if section.settings.show_vendor -%}
            {%- if section.settings.show_vendor -%}
              {% comment %} Get list of Product Tags to Identify if Vendor is tagged as Canadian {% endcomment %}
              {% assign product_tags = product.tags | join: ', ' %}
              {%- assign vendor_handle = product.vendor | handle -%}
              {%- assign collection_for_vendor = collections[vendor_handle] -%}
              <!-- Vendor: {{ product.vendor }} -->
              {%- unless collection_for_vendor.empty? -%}
                <!-- "in unless" -->
                {% if product.metafields.global.manufacturer != blank %}
                  {% assign manufacturer = product.metafields.global.manufacturer %}
                {% else %}
                  {% assign manufacturer = product.vendor %}
                {% endif %}
                By
                <a class="product-meta__vendor link link--accented" href="{{ collection_for_vendor.url }}"
                  ><span class="product-meta__vendor">{{ manufacturer }}</span></a
                >
                <!-- {{ product.vendor }}</a> -->
                {% if product_tags contains 'Vendor-Canadian' %}
                  <a href="{{ collections['canadian-vendors'].url }}">
                    <span class="canada-flag">&nbsp;</span>
                  </a>
                {% endif %}
              {%- else -%}
                <!-- "in else" -->

                {% if product.metafields.global.manufacturer != blank %}
                  {% assign manufacturer = product.metafields.global.manufacturer %}
                {% else %}
                  {% assign manufacturer = product.vendor %}
                {% endif %}

                By
                <a class="product-meta__vendor link link--accented" href="{{ product.vendor | url_for_vendor }}"
                  ><span class="product-meta__vendor">{{ manufacturer }}</span></a
                >
                <!--
                  <a class="product-meta__vendor link link--accented" href="{{ product.vendor | url_for_vendor }}">{{ product.vendor }}</a>
                -->
                {% if product_tags contains 'Vendor-Canadian' %}
                  <a href="{{ collections['canadian-vendors'].url }}">
                    <span class="canada-flag">&nbsp;</span>
                  </a>
                {% endif %}
              {%- endunless -%}
            {%- endif -%}
          {%- endif -%}

          {%- if settings.show_discount -%}
            {%- assign savings = 0 -%}

            {%- if settings.discount_mode == 'percentage' -%}
              {%- assign savings = selected_variant.compare_at_price
                | minus: selected_variant.price
                | times: 100.0
                | divided_by: selected_variant.compare_at_price
                | round
                | append: '%'
              -%}
            {%- else -%}
              {%- capture savings -%}<span>{{ selected_variant.compare_at_price | minus: selected_variant.price | money }}</span>{%- endcapture -%}
            {%- endif -%}
          {%- endif -%}
          <span
            class="product-label product-label--meta product-label--on-sale"
            {% unless selected_variant.price < selected_variant.compare_at_price %}
              style="display: none"
            {% endunless %}
          >
            {{- 'collection.product.discount_html' | t: savings: savings -}}
          </span>
        </div>

        <h1 class="product-meta__title heading h1">{{ product.title }}</h1>
      {%- else -%}
        <h3 class="product-meta__title heading h2">
          <a href="{{ product.url }}">{{ product.title }}</a>
        </h3>
      {%- endif -%}
      <div class="product__block--review">
        <div class="product__reviews">
          {% render 'okendo-reviews-product-rating-summary', product: product %} 
        </div>
        {%- if section.settings.show_share_buttons -%}
          <div class="product-meta__share-buttons">
            {{ share_buttons }}
          </div>
        {%- endif -%}
       </div>
      <div class="product-meta__additional-info">
        <span class="product-meta__type">
          {% if product.type != blank %}
            {% assign type_display = product.type %}
          {% else %}
            {% assign type_display = 'Health Supplement' %}
          {% endif %}

          <strong>{{ type_display }}</strong>&nbsp;|&nbsp;
        </span>
        {%- if section.settings.show_sku -%}
          <span
            class="product-meta__sku"
            {% if selected_variant.sku == blank %}
              style="display: none"
            {% endif %}
          >
            {{- 'product.general.sku' | t -}}
            <span class="product-meta__sku-number">{{ selected_variant.sku }}</span>
          </span>
        {%- endif -%}

        {%- capture product_labels -%}
          {%- for tag in product.tags -%}
            {%- if tag contains '__label:' -%}            
              <span class="product-label product-label--custom1 no-bg">{{ tag | split: '__label:' | last }}</span>
            {%- endif -%}

            {%- if tag contains '__label1:' -%}
              <span class="product-label product-label--custom1 no-bg">{{ tag | split: '__label1:' | last }}</span>
            {%- endif -%}

            {%- if tag contains '__label2:' -%}
              <span class="product-label product-label--custom2 no-bg">{{ tag | split: '__label2:' | last }}</span>
            {%- endif -%}
          {%- endfor -%}
        {%- endcapture -%}
      </div>
      {%- for variant in product.variants -%}
        {% if variant.metafields.custom.expiry_date %}
          <div class="product-meta__label-list">
            <span
              data-o1="{{ variant.option1 }}"
              data-02="{{ variant.option2 }}"
              id="expiry-{{ variant.id }}"
              class="variant-expiry-date product-label product-label--custom2 no-bg"
              {% if selected_variant.id != variant.id %}
                style="display: none"
              {% endif %}
              data-id="{{ variant.id }}"
              data-date="{{ variant.metafields.custom.expiry_date }}"
            >
              Expiry Date: {{ variant.metafields.custom.expiry_date | date: '%b %d, %Y' }}
            </span>
          </div>
        {% endif %}
      {%- endfor -%}

     <div class="tag-button-flex">
      <div class="product-meta__label-list tags">
        {%- if product_labels != blank -%}
          <span>{{- product_labels -}}</span>
        {%- endif -%}
        {%- for variant in product.variants -%}
          {% if variant.metafields.custom.variant_tag %}
            <span>
              {% assign tag = variant.metafields.custom.variant_tag.value %}
              {% for value in tag %}
                <span
                  data-o1="{{ variant.option1 }}"
                  data-02="{{ variant.option2 }}"
                  id="variantTag-{{ variant.id }}"
                  class="variant-tag product-label product-label--custom1 no-bg variant-tag-{{ variant.id }}"
                  {% if selected_variant.id != variant.id %}
                    style="display: none"
                  {% endif %}
                  data-id="{{ variant.id }}"
                >
                  {{ value }}
                </span>
              {% endfor %}
            </span>
          {% endif %}
        {%- endfor -%}
      </div>
    </div>
    </div>

    <hr class="card__separator">

    <div class="product-meta__description rte" id="quickviewDescription">
      {{ product.description | replace: '<br>', ' ' | truncate: 100, '' }}... <a href="{{product.url}}">Read More</a>
    </div>

    {%- if request.page_type == 'index'
      and section.settings.show_description
      and product.description != blank
      and section.settings.description_below_add_to_cart == false
    -%}
      <div class="product-meta__description rte">
        {{ product.description | remove: 'data-section-type="product"' }}
      </div>
    {%- endif -%}

    {% comment %}
      ------------------------------------------------------------------------------
      PRODUCT FORM
      ------------------------------------------------------------------------------
    {% endcomment %}
    {% assign sorted_option_array = '' %}
    {% assign sorted_option_index = '' %}

    {%- assign color_label = 'color,colour,couleur,cor,colore,farbe,색,色,カラー,färg,farve,szín' | split: ',' -%}

    {%- form 'product', product, class: 'product-form' -%}
      {%- unless product.has_only_default_variant -%}
        <div class="product-form__variants">
          {%- for option in product.options_with_values -%}
            {% assign optionForLoop = forloop.index %}
            {%- assign downcase_option = option.name | downcase -%}
            {%- capture option_name -%}{{ section.id }}-{{ product.id }}-{{ forloop.index }}{%- endcapture -%}

            {%- assign option_selector_type = 'select' -%}

            {%- if section.settings.color_mode != 'block'
              and section.settings.color_mode != 'dropdown'
              and color_label contains downcase_option
            -%}
              {%- comment -%}NOTE: even if the merchant is using the mode to display variant images, if ALL variant do not have an associated image, we fallback to color{%- endcomment -%}

              {%- assign has_image_attached_to_all_variants = true -%}

              {%- for variant in product.variants -%}
                {%- unless variant.image -%}
                  {%- assign has_image_attached_to_all_variants = false -%}
                  {%- break -%}
                {%- endunless -%}
              {%- endfor -%}

              {%- if section.settings.color_mode == 'color' or has_image_attached_to_all_variants == false -%}
                {%- assign option_selector_type = 'color' -%}
              {%- else -%}
                {%- assign option_selector_type = 'variant' -%}
              {%- endif -%}
            {%- else -%}
              {%- if color_label contains downcase_option -%}
                {%- if section.settings.color_mode == 'block' -%}
                  {%- assign option_selector_type = 'block' -%}
                {%- endif -%}
              {%- elsif section.settings.selector_mode == 'block' -%}
                {%- assign option_selector_type = 'block' -%}
              {%- endif -%}
            {%- endif -%}
            <div class="product-form__option" data-options-container data-selector-type="{{ option_selector_type }}">
              {%- case option_selector_type -%}
                {%- when 'color' -%}
                  <span class="product-form__option-name text--strong">
                    {{- option.name }}:
                    <span class="product-form__selected-value">{{ option.selected_value }}</span></span
                  >

                  <div class="color-swatch-list color-swatch-list--large">
                    {%- for value in option.values -%}
                      {%- assign downcased_value = value | downcase -%}
                      {%- capture color_id -%}{{ option_name }}-{{ forloop.index }}{%- endcapture -%}

                      {%- assign color_swatch_name = value | handle | append: '.png' -%}
                      {%- assign color_swatch_image = images[color_swatch_name] -%}

                      <div
                        class="color-swatch {% if downcased_value == 'white' or downcased_value == 'blanc' %}color-swatch--white{% endif %}"
                        data-option
                      >
                        <input
                          class="color-swatch__radio product-form__single-selector"
                          data-selector
                          type="radio"
                          name="{{ option_name }}"
                          id="{{ color_id }}"
                          value="{{ value | escape }}"
                          {% if option.selected_value == value %}
                            checked
                          {% endif %}
                          data-option-position="{{ option.position }}"
                        >
                        <label
                          class="color-swatch__item lazyload"
                          for="{{ color_id }}"
                          {% if color_swatch_image != blank %}
                            data-bg="{{ color_swatch_image | img_url: '64x64' }}"
                          {% else %}
                            style="background-color: {{ value | replace: ' ', '' | downcase }}"
                          {% endif %}
                          title="{{ value | escape }}"
                        >
                          <span class="visually-hidden">{{ value }}</span>
                          {%- render 'icon', icon: 'cross-sold-out' -%}
                        </label>
                      </div>
                    {%- endfor -%}
                  </div>

                {%- when 'variant' -%}
                  <span class="product-form__option-name text--strong">
                    {{- option.name }}:
                    <span class="product-form__selected-value">{{ option.selected_value }}</span></span
                  >

                  <div class="variant-swatch-list">
                    {%- capture option_name -%}option{{ option.position }}{%- endcapture -%}

                    {%- for value in option.values -%}
                      {%- capture variant_swatch_id -%}{{ option_name }}-{{ forloop.index }}{%- endcapture -%}

                      {%- for variant in product.variants -%}
                        {%- if variant[option_name] == value and variant.image -%}
                          <div class="variant-swatch">
                            <input
                              class="variant-swatch__radio product-form__single-selector"
                              data-selector
                              type="radio"
                              name="{{ option_name }}"
                              id="{{ variant_swatch_id }}"
                              value="{{ value | escape }}"
                              {% if option.selected_value == value %}
                                checked
                              {% endif %}
                              data-option-position="{{ option.position }}"
                            >

                            <label
                              class="variant-swatch__item"
                              for="{{ variant_swatch_id }}"
                              title="{{ value | escape }}"
                            >
                              <div
                                class="aspect-ratio"
                                style="padding-bottom: {{ 100.0 | divided_by: variant.image.aspect_ratio }}%"
                              >
                                <img src="{{ variant.image | img_url: '120x' }}" alt="{{ variant.image.alt | escape }}">
                              </div>

                              {% render 'icon', icon: 'cross-sold-out' %}
                            </label>
                          </div>

                          {%- break -%}
                        {%- endif -%}
                      {%- endfor -%}
                    {%- endfor -%}
                  </div>
                {%- when 'block' -%}
                  <span class="product-form__option-name text--strong">Select {{ option.name }}</span>
                  <div class="block-swatch-list">
                    {%- for value in option.values -%}
                      {%- capture block_swatch_id -%}{{ option_name }}-{{ forloop.index }}{%- endcapture -%}
                      <div class="block-swatch {{ forloop.index }}">
                        <input
                          class="block-swatch__radio product-form__single-selector"
                          data-selector
                          type="radio"
                          name="{{ option_name }}"
                          id="{{ block_swatch_id }}"
                          value="{{ value | escape }}"
                          {% if option.selected_value == value %}
                            checked
                          {% endif %}
                          data-option-position="{{ option.position }}"
                        >
                        <label class="block-swatch__item" for="{{ block_swatch_id }}" title="{{ value | escape }}">
                          <span class="block-swatch__item-text">{{ value }}</span>
                        </label>
                      </div>
                    {%- endfor -%}
                  </div>

                {%- when 'select' -%}
                  <label for="{{ option_name }}" class="product-form__option-name text--strong"
                    >Select {{ option.name -}}
                  </label>
                  {% comment %} <label for="{{ option_name }}" class="product-form__option-name text--strong">{{ option.name }}: <span class="product-form__selected-value">{{ option.selected_value }}</span></label> {% endcomment %}
                  <div class="select-wrapper select-wrapper--primary">
                    <span class="pipeline-icon">{%- render 'icon', icon: 'pipeline-filled-red' -%}</span>
                    {%- render 'icon', icon: 'arrow-bottom-filled' -%}

                    <select
                      class="product-form__single-selector"
                      data-selector
                      name="{{ option_name }}"
                      id="{{ option_name }}"
                      data-option-position="{{ option.position }}"
                    >
                      {%- for value in option.values -%}
                        <option
                          class="select-option"
                          value="{{ value | escape }}"
                          data-option
                          {% if value == option.selected_value %}
                            selected="selected"
                          {% endif %}
                        >
                          {{ value }}
                        </option>
                      {%- endfor -%}
                    </select>
                  </div>
              {%- endcase -%}
            </div>

            {% comment %}
              Experimental code. Do no
               {% assign count_customer_seperator = option.values.size | append: '::custom-count-seperator' %}
               {% assign sort_item = '' | prepend: count_customer_seperator | append: '::custom-seperator' %}
               {% assign array_size = sorted_option_array | split: '::custom-seperator' %}
               {% if array_size.size <= 0 %}
                 {% assign sorted_option_array = sorted_option_array | append: sort_item %}
                 {% assign sorted_option_index = sorted_option_index | append: optionForLoop | join: ',' %}
               {% else %}
                 {% assign last_array_item = sorted_option_array | split: '::custom-seperator' | first %}
                 {% assign last_array_item_count = last_array_item | split: '::custom-count-seperator' | first | plus: 0 %}
                 {% if option.values.size <= last_array_item_count %}
                   {% assign sorted_option_array_list = sorted_option_array | split: '::custom-seperator' %}
                   {% for sorted_option in sorted_option_array_list %}
                     {% assign current_option_size = sorted_option | split: '::custom-count-seperator' | first | plus: 0 %}
                     {% if current_option_size <= option.values.size %}
                       {% assign sorted_option_array = sorted_option_array | prepend: sort_item %}
                        {% assign sorted_option_index = sorted_option_index | append: optionForLoop | minus: 1 | join: ',' %}
                       {% break %}
                     {% endif %}
                     {% if forloop.last %}
                       {% assign sorted_option_array = sorted_option_array | append: sort_item %}
                       {% assign sorted_option_index = sorted_option_index | append: optionForLoop | plus: 1 | join: ',' %}
                     {% endif %}
                   {% endfor %}
                 {% else %}
                   {% assign sorted_option_array = sorted_option_array | prepend: sort_item %}
                   {% assign sorted_option_index = sorted_option_index | append: optionForLoop | minus: 1 | join: ',' %}
                 {% endif %}
               {% endif %}
            {% endcomment %}
          {%- endfor -%}

          <div class="no-js product-form__option">
            <label for="product-select-{{ product.id }}">{{ 'product.form.variant' | t }}</label>

            <div class="select-wrapper select-wrapper--primary">
              <select id="product-select-{{ product.id }}" name="id">
                {%- for variant in product.variants -%}
                  <option
                    {% if variant == selected_variant %}
                      selected="selected"
                    {% endif %}
                    {% unless variant.available %}
                      disabled="disabled"
                    {% endunless %}
                    value="{{ variant.id }}"
                    data-sku="{{ variant.sku }}"
                  >
                    {{ variant.title }} - {{ variant.price | money }}
                  </option>
                {%- endfor -%}
              </select>
            </div>
          </div>
        </div>
      {%- else -%}
        <input type="hidden" name="id" data-sku="{{ selected_variant.sku }}" value="{{ selected_variant.id }}">
      {%- endunless -%}

      <div class="product-form__info-list">
        <div class="product-form__info-item">
          {% comment %} <span class="product-form__info-title text--strong">{{ 'product.form.price' | t }}:</span> {% endcomment %}

          <div class="product-form__info-content" role="region" aria-live="polite">
            <div class="price-list">
              {%- if selected_variant.compare_at_price > selected_variant.price -%}
                <span class="price price--compare">
                  <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>
                  {{- selected_variant.compare_at_price | money -}}
                </span>

                <span class="price price--highlight" style="font-weight: bold;">
                  <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                  {{- selected_variant.price | money_with_currency -}}
                </span>

              {%- else -%}
                <span class="price">
                  <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                  {{- selected_variant.price | money_with_currency -}}
                </span>
              {%- endif -%}
            </div>

            <div
              class="product-form__price-info"
              style="display: {% if selected_variant.unit_price_measurement %}block{% else %}none{% endif %}"
            >
              <div class="unit-price-measurement">
                <span class="unit-price-measurement__price">{{ selected_variant.unit_price | money }}</span>
                <span class="unit-price-measurement__separator">/ </span>

                <span
                  class="unit-price-measurement__reference-value"
                  {%- if selected_variant.unit_price_measurement.reference_value == 1 -%}
                    style="display: none"
                  {% endif %}
                >
                  {{- selected_variant.unit_price_measurement.reference_value -}}
                </span>

                <span class="unit-price-measurement__reference-unit">
                  {{- selected_variant.unit_price_measurement.reference_unit -}}
                </span>
              </div>
            </div>

            {%- if section.settings.show_taxes_included -%}
              {%- if shop.taxes_included or shop.shipping_policy.body != blank -%}
                <p class="product-form__price-info">
                  {%- if shop.taxes_included -%}
                    {{ 'product.general.include_taxes' | t }}
                  {%- endif -%}

                  {%- if shop.shipping_policy.body != blank -%}
                    {{ 'product.general.shipping_policy_html' | t: link: shop.shipping_policy.url }}
                  {%- endif -%}
                </p>
              {%- endif -%}
            {%- endif -%}
          </div>
        </div>

        {%- if section.settings.show_inventory_quantity and product.template_suffix != 'pre-order' -%}
          <div class="product-form__info-item">
            <span class="product-form__info-title text--strong">{{ 'product.form.inventory' | t }}:</span>

            <div class="product-form__info-content">
              {%- if selected_variant.available -%}
                {%- if selected_variant.inventory_management
                  and selected_variant.inventory_policy == 'deny'
                  and section.settings.low_inventory_threshold > 0
                -%}
                  {%- if selected_variant.inventory_quantity <= section.settings.low_inventory_threshold -%}
                    <span class="product-form__inventory inventory inventory--low">
                      {{-
                        'product.form.low_stock_with_quantity_count'
                        | t: count: selected_variant.inventory_quantity
                      -}}
                    </span>
                  {%- else -%}
                    <span class="product-form__inventory inventory inventory--high">
                      {{-
                        'product.form.in_stock_with_quantity_count'
                        | t: count: selected_variant.inventory_quantity
                      -}}
                    </span>
                  {%- endif -%}
                {%- else -%}
                  {%- if selected_variant.inventory_policy == 'continue'
                    and selected_variant.inventory_quantity <= 0
                    and selected_variant.requires_shipping
                  -%}
                    <span class="product-form__inventory inventory inventory--high">
                      {{- 'product.form.oversell_stock' | t -}}
                    </span>
                  {%- else -%}
                    <span class="product-form__inventory inventory inventory--high">
                      {{- 'product.form.in_stock' | t -}}
                    </span>
                  {%- endif -%}
                {%- endif -%}
              {%- else -%}
                <span class="product-form__inventory inventory">{{ 'product.form.sold_out' | t }}</span>
              {%- endif -%}

              {%- for tag in product.tags -%}
                {%- if tag contains '__stock:' -%}
                  {%- assign stock_countdown_max = tag | split: '__stock:' | last | times: 1.0 -%}
                  {%- assign stock_countdown_progress = selected_variant.inventory_quantity
                    | divided_by: stock_countdown_max
                    | times: 100.0
                    | at_least: 0
                    | at_most: 100
                  -%}

                  <span
                    class="inventory-bar {% if stock_countdown_progress == 0 %}inventory-bar--hidden{% endif %}"
                    data-stock-countdown-max="{{ stock_countdown_max }}"
                  >
                    <span class="inventory-bar__progress" style="width: 100%"></span>
                  </span>
                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}
            </div>
          </div>
        {%- endif -%}

        {%- if product.template_suffix != 'contact' -%}
          {%- if section.settings.show_quantity_selector -%}
            <div class="product-form__info-item product-form__info-item--quantity">
              {% comment %}
                <label for="{{ section.id }}-{{ product.id }}-quantity" class="product-form__info-title text--strong">
                  {{- 'product.form.quantity' | t }}:</label
                >
              {% endcomment %}
              <div class="product-form__info-content">
                <div class="quantity-selector quantity-selector--product">
                  <button
                    type="button"
                    class="quantity-selector__button"
                    data-action="decrease-picker-quantity"
                    aria-label="{{ 'cart.items.decrease_quantity' | t }}"
                    title="{{ 'cart.items.decrease_quantity' | t }}"
                  >
                    {% render 'icon', icon: 'minus' %}
                  </button>
                  <input
                    name="quantity"
                    aria-label="{{ 'product.form.quantity' | t }}"
                    class="quantity-selector__value"
                    inputmode="numeric"
                    value="1"
                    size="3"
                    oninput="if(this.value>Number(this.max))this.value=Number(this.max);"
                    min="0"
                    max="{%- for variant in product.variants -%}{%- if selected_variant.id == variant.id -%}{{variant.inventory_quantity}}{%- endif -%}{%- endfor -%}"
                  >
                  <button
                    type="button"
                    class="quantity-selector__button"
                    data-action="increase-picker-quantity"
                    aria-label="{{ 'cart.items.increase_quantity' | t }}"
                    title="{{ 'cart.items.increase_quantity' | t }}"
                    onclick="if(Number(this.previousElementSibling.value)>=Number(this.previousElementSibling.max))this.previousElementSibling.value=Number(this.previousElementSibling.max)-1;"
                  >
                    {% render 'icon', icon: 'plus' %}
                  </button>
                </div>
                {%- if product.template_suffix != 'contact' -%}
                  {%- if selected_variant.available -%}
                    {%- if product.template_suffix == 'pre-order' -%}
                      <button
                        type="submit"
                        class="product-form__add-button button button--primary"
                        {% comment %} data-action="add-to-cart"{% endcomment %}
                      >
                        {{ 'product.form.pre_order' | t }}
                      </button>
                    {%- else -%}
                      <button
                        type="submit"
                        class="product-form__add-button button button--primary quick-add-to-cart sticky"
                        {% comment %} data-action="add-to-cart"{% endcomment %}
                      >
                        {{ 'product.form.add_to_cart' | t }}
                      </button>
                    {%- endif -%}
                  {%- else -%}
                    <button type="submit" class="product-form__add-button button button--disabled" disabled>
                      {{ 'product.form.sold_out' | t }}
                    </button>
                  {%- endif -%}
                {%- endif -%}
              </div>
            </div>
          {%- else -%}
            <input type="hidden" name="quantity" value="1">
          {%- endif -%}
        {%- endif -%}
      </div>

      {%- assign collection_handle = '' -%}
      {% for tag in product.tags %}
        {% if tag contains '__collection:' %}
          {%- assign collection_handle = tag | split: '__collection:' | last -%}
        {% endif %}
      {% endfor %}

      {% liquid
        assign collection = collections[collection_handle]
        assign product_data = collection.metafields.custom.free_product.value
      %}

      {% if collection.handle.size > 0 %}
        {{ 'product-info.css' | asset_url | stylesheet_tag }}
        <div class="complimentary__wrapper">
          <img class="complimentary__wrapper_image" src="{{ product_data.complimentary_product | img_url: '85x' }}">

          <div class="complimentary__wrapper--content">
            {% if product_data.complimentary_title != blank %}
              <h2 class="cp__title">
                {% render 'complimentary-check-icon' %}
                {{ product_data.complimentary_title }}
              </h2>
            {% endif %}
            {% if product_data.product_description != blank %}
              <div class="complimentary__wrapper--description">{{ product_data.product_description }}</div>
            {% endif %}
          </div>
        </div>
      {% endif %}

      <div class="product-form__payment-container">
        {% if product.tags contains 'free-VitaminD3' %}
          <div class="bundle-container-wrapper">
            <div class="bundle-container">
              <div class="bundle-button-wrapper">
                <img
                  class="deal-img"
                  src="https://cdn.shopify.com/s/files/1/0422/2255/1191/products/NATWAYVITD3_1_500x.jpg?v=1662589655"
                >
                <div class="deal-msg">Buy any NutraSea Omega 3 and get Nature's Way Vitamin D3 Gummies for FREE</div>
                <button class="deal-btn product-form__add-button button button--primary" id="add-bundle">
                  Add Deal to Cart
                </button>
              </div>

              <div class="bundle__wrapper" style="display:none;">
                <div class="bundle-panel__bundle">
                  <div class="bundle-panel__item">
                    <input
                      type="checkbox"
                      name="bundle[]"
                      id="bundle-42501456691351"
                      type="checkbox"
                      value="42501456691351"
                      data-product="42501456691351"
                      checked
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endif %}

        {%- if product.template_suffix != 'contact' -%}
          {% comment %}
            {%- if selected_variant.available -%}
              {%- if product.template_suffix == 'pre-order' -%}
                <button
                  type="submit"
                  class="product-form__add-button button button--primary"
                  {% comment %} data-action="add-to-cart"{% endcomment %}
                >
                  {{ 'product.form.pre_order' | t }}
                </button>
              {%- else -%}
                <button
                  type="submit"
                  class="product-form__add-button button button--primary quick-add-to-cart"
                  {% comment %} data-action="add-to-cart"{% endcomment %}
                >
                  {{ 'product.form.add_to_cart' | t }}
                </button>
              {%- endif -%}
            {%- else -%}
              <button type="submit" class="product-form__add-button button button--disabled" disabled>
                {{ 'product.form.sold_out' | t }}
              </button>
            {%- endif -%}
          {% endcomment %}

          {%- if section.settings.show_payment_button and product.template_suffix != 'pre-order' -%}
            {{ form | payment_button }}
          {%- endif -%}
        {%- else -%}
          <a href="mailto:{{ shop.email }}" class="button button--primary">{{ 'product.form.contact_us' | t }}</a>
        {%- endif -%}
      </div>
    {%- endform -%}

    {%- comment -%}The availability container will be added automatically if there is store pickup available{%- endcomment -%}
    {%- if section.settings.show_pickup_availability -%}
      <div class="product-meta__store-availability-container"></div>
    {%- endif -%}

    {%- if request.page_type == 'index'
      and section.settings.show_description
      and product.description != blank
      and section.settings.description_below_add_to_cart
    -%}
      <div class="product-meta__description rte">
        {{ product.description }}
      </div>
    {%- endif -%}

  </div>

  {%- if section.settings.show_payment_button and product.selected_or_first_available_variant.available == false -%}
    <style>
      #shopify-section-{{ section.id }} .shopify-payment-button {
        display: none;
      }
    </style>
  {%- endif -%}

  {% comment %}
    ------------------------------------------------------------------------------
    Product Data. This must be outputted for all products (including home page).

    IMPORTANT: THIS CODE IS VITAL. DO NOT EDIT IT NOT REMOVE IT. MAKE SURE TO KEEP
    THE EXACT SAME ATTRIBUTES.
    ------------------------------------------------------------------------------
  {% endcomment %}

  <script type="application/json" data-product-json>
    {
      "product": {{ product | json }},
      "options_with_values": {{ product.options_with_values | json }},
      "selected_variant_id": {{ selected_variant.id }}
      {%- if section.settings.show_inventory_quantity -%}
        ,"inventories": {
          {%- for variant in product.variants -%}
            {%- if variant.available -%}
              {%- if variant.inventory_management and variant.inventory_policy == 'deny' and section.settings.low_inventory_threshold > 0 -%}
                {%- if variant.inventory_quantity <= section.settings.low_inventory_threshold -%}
                  {%- capture inventory_message -%}{{ 'product.form.low_stock_with_quantity_count' | t: count: variant.inventory_quantity }}{%- endcapture -%}
                {%- else -%}
                  {%- capture inventory_message -%}{{ 'product.form.in_stock_with_quantity_count' | t: count: variant.inventory_quantity }}{%- endcapture -%}
                {%- endif -%}
              {%- else -%}
                {%- if variant.inventory_policy == 'continue' and variant.inventory_quantity <= 0 and selected_variant.requires_shipping -%}
                  {%- capture inventory_message -%}{{ 'product.form.oversell_stock' | t }}{%- endcapture -%}
                {%- else %}
                  {%- capture inventory_message -%}{{ 'product.form.in_stock' | t }}{%- endcapture -%}
                {%- endif -%}
              {%- endif -%}
            {%- else -%}
              {%- capture inventory_message -%}{{ 'product.form.sold_out' | t }}{%- endcapture -%}
            {%- endif -%}

            "{{ variant.id }}": {
              "inventory_management": {{ variant.inventory_management | json }},
              "inventory_policy": {{ variant.inventory_policy | json }},
              "inventory_quantity": {{ variant.inventory_quantity | json }},
              "inventory_message": {{ inventory_message | json }}
            }{% unless forloop.last %},{% endunless %}
          {%- endfor -%}
        }
      {%- endif -%}
    }
  </script>
  <script>
    // Mutation Observer to Listen the classname change in Flavour variant div
    window.addEventListener('DOMContentLoaded', function (event) {
      let formVarFirst = document.querySelectorAll('[data-options-container]')[1];
      let formVarFirstSwatch = formVarFirst.querySelectorAll('[data-option]');
      function callback(mutationsList, observer) {
        mutationsList.forEach((mutation) => {
          if (mutation.attributeName === 'class') {
            for (let i = 0; i < formVarFirstSwatch.length; i++) {
              if (!formVarFirstSwatch[i].classList.contains('disabled')) {
                const select = formVarFirstSwatch[i].closest('select');
                if (select) {
                  select.value = formVarFirstSwatch[i].value;
                  select.dispatchEvent(new Event('change', { bubbles: true }));
                  break;
                } else {
                  formVarFirstSwatch[i].querySelector('data-selector').click();
                  break;
                }
              }
            }
          }
        });
      }

      // Observer for second variant
      const mutationObserver = new MutationObserver(callback);
      for (let i = 0; i < formVarFirstSwatch.length; i++) {
        mutationObserver.observe(formVarFirstSwatch[i], { attributes: true });
      }
      // Check for third variant is exist
      let formVariants = document.querySelectorAll('.product-form__variants [data-selector-type]');
      if (formVariants.length > 2) {
        let formThirdVariant = document.querySelectorAll('[data-options-container]')[2];
        let formThirdVarSwatch = formThirdVariant.querySelectorAll('[data-option]');
        function callback(mutationsList, observer) {
          mutationsList.forEach((mutation) => {
            if (mutation.attributeName === 'class') {
              for (let i = 0; i < formThirdVarSwatch.length; i++) {
                if (!formThirdVarSwatch[i].classList.contains('disabled')) {
                  const select = formThirdVarSwatch[i].querySelector('select');
                  if (select) {
                    select.value = formThirdVarSwatch[i].value;
                    select.dispatchEvent(new Event('change', { bubbles: true }));
                    break;
                  } else {
                    formThirdVarSwatch[i].querySelector('data-selector').click();
                    break;
                  }
                }
              }
            }
          });
        }

        // Observer for Third variant
        const mutationObserverThird = new MutationObserver(callback);
        for (let i = 0; i < formThirdVarSwatch.length; i++) {
          mutationObserverThird.observe(formThirdVarSwatch[i], { attributes: true });
        }
      }
      let colorDiv = document.querySelectorAll('.product-form__variants .product-form__option[data-selector-type]');
      let swatchVariantSelectorType = colorDiv[colorDiv.length - 1].dataset.selectorType;
      if (swatchVariantSelectorType == 'color') {
        let formColorVar = colorDiv[colorDiv.length - 1];
        let formColorVarSwatch = formColorVar.querySelectorAll('.color-swatch-list .color-swatch');
        function callback(mutationsList, observer) {
          mutationsList.forEach((mutation) => {
            if (mutation.attributeName === 'class') {
              for (let i = 0; i < formColorVarSwatch.length; i++) {
                if (!formColorVarSwatch[i].classList.contains('disabled')) {
                  formColorVarSwatch[i].querySelector('.color-swatch__radio').click();
                  break;
                }
              }
            }
          });
        }

        // Observer for last Color variant
        const mutationObserverThird = new MutationObserver(callback);
        for (let i = 0; i < formColorVarSwatch.length; i++) {
          mutationObserverThird.observe(formColorVarSwatch[i], { attributes: true });
        }
      }
    });
  </script>
  <script>
    document.addEventListener('variant:changed', function (event) {
      $('.variant-tag').hide();
      let variant = event.detail.variant;
      let id = '.variant-tag-' + variant.id;
      $(id).show();
    });
  </script>
  <script>
    document.addEventListener('variant:changed', function (event) {
      $('.variant-expiry-date').hide();
      let variant = event.detail.variant;
      let id = '#expiry-' + variant.id;
      $(id).show();
    });
  </script>
</div>
